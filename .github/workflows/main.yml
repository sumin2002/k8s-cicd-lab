name: CI/CD to Harbor

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted  # ğŸ‘ˆ [ì¤‘ìš”] ì•„ê¹Œ ì„¤ì¹˜í•œ ì§‘ì‚¬(Runner) ì‚¬ìš©!

    steps:
    - uses: actions/checkout@v3

    - name: Build Docker Image
      # Harbor ì£¼ì†Œì™€ ì´ë¯¸ì§€ ì´ë¦„ì„ ê²°í•©í•´ì„œ ë¹Œë“œ
      run: docker build -t ${{ secrets.HARBOR_URL }}/library/my-web-app:${{ github.sha }} .

    - name: Login to Harbor
      # Harborì— ë¡œê·¸ì¸ (ë³´ì•ˆìƒ íŒ¨ìŠ¤ì›Œë“œ ì§ì ‘ ì…ë ¥ ëŒ€ì‹  stdin ì‚¬ìš©)
      run: echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ secrets.HARBOR_URL }} -u ${{ secrets.HARBOR_USERNAME }} --password-stdin

    - name: Push to Harbor
      # ë¹Œë“œí•œ ì´ë¯¸ì§€ë¥¼ Harborë¡œ ì „ì†¡
      run: docker push ${{ secrets.HARBOR_URL }}/library/my-web-app:${{ github.sha }}

    - name: Update Kubernetes Manifest
      # deployment.yaml íŒŒì¼ì˜ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ìµœì‹  ë²„ì „ìœ¼ë¡œ ìˆ˜ì •
      run: |
        sed -i "s|image: .*|image: ${{ secrets.HARBOR_URL }}/library/my-web-app:${{ github.sha }}|g" deployment.yaml
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add deployment.yaml
        git commit -m "Update image tag to ${{ github.sha }}"
        git push
