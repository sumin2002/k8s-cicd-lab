name: CI/CD to Harbor

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3

    # [1] 도커 빌드 (여기는 외부 접속용 IP인 1.19 또는 Secret 변수 사용)
    - name: Build Docker Image
      run: docker build -t ${{ secrets.HARBOR_URL }}/library/my-web-app:${{ github.sha }} .

    # [2] 하버 로그인
    - name: Login to Harbor
      run: echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ secrets.HARBOR_URL }} -u ${{ secrets.HARBOR_USERNAME }} --password-stdin

    # [3] 도커 푸시 (이미지 업로드)
    - name: Push to Harbor
      run: docker push ${{ secrets.HARBOR_URL }}/library/my-web-app:${{ github.sha }}

    # [4] 쿠버네티스 매니페스트 수정 (여기가 충돌 해결의 핵심!)
    - name: Update Kubernetes Manifest
      run: |
        # 1. 꼬인 족보 초기화: 무조건 원격 저장소의 최신 상태로 강제 리셋
        git fetch origin main
        git reset --hard origin/main

        # 2. 파일 수정: 쿠버네티스 내부용 IP (10.20)으로 변경
        sed -i "s|image: .*|image: 192.168.10.20/library/my-web-app:${{ github.sha }}|g" deployment.yaml
        
        # 3. 커밋 및 푸시 (이제 충돌 없이 무조건 성공함)
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add deployment.yaml
        git commit -m "Update image tag to ${{ github.sha }}"
        git push origin main
