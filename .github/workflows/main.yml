name: CI/CD to Harbor

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3

    - name: Build Docker Image
      # [수정됨] 에러 나던 build-push-action 대신, 표준 명령어 사용!
      run: docker build -t ${{ secrets.HARBOR_URL }}/library/my-web-app:${{ github.sha }} .

    - name: Login to Harbor
      run: echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ secrets.HARBOR_URL }} -u ${{ secrets.HARBOR_USERNAME }} --password-stdin

    - name: Push to Harbor
      run: docker push ${{ secrets.HARBOR_URL }}/library/my-web-app:${{ github.sha }}

    - name: Update Kubernetes Manifest
      run: |
        sed -i "s|image: .*|image: ${{ secrets.HARBOR_URL }}/library/my-web-app:${{ github.sha }}|g" deployment.yaml
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add deployment.yaml
        git commit -m "Update image tag to ${{ github.sha }}"
        git push
